name: Build and Deploy site

on:
  push:
    branches:
      - main
      - '**' # All branches
  release:
    types: [published]


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: pip install -r docs/requirements.txt

      - name: Install CMake and Doxygen
        run: sudo apt-get update && sudo apt-get install -y cmake doxygen graphviz libhdf5-dev gfortran

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DACHILLES_BUILD_DOCS=ON
        working-directory: .

      - name: Build documentation
        run: |
          cd build
          cmake --build . --target achilles-docs
        working-directory: .

      - name: Mark timestamp for branch builds
        if: github.event_name == 'push'
        run: date -u +"%Y-%m-%dT%H:%M:%SZ" > build/docs/sphinx/.last_updated

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Copy docs
        run: |
          BRANCH=${GITHUB_REF_NAME}
          mkdir -p gh-pages/$BRANCH
          rsync -a --delete build/docs/sphinx/ gh-pages/$BRANCH/

      - name: Update versions.json
        run: |
          cd gh-pages
          ls -d */ | cut -f1 -d'/' | grep -v 'latest' \
            | jq -R . | jq -s . > versions.json

      - name: Deploy docs
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          publish_branch: gh-pages
          keep_files: true
